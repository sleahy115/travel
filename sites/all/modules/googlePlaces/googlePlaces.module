<?php
    function googlePlaces_menu()
    {
        $items = array();
        $items['travel_options'] = array(
      'title' => 'Search Attractions',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('travel_form'),
      'access callback' => true,
      'type' => MENU_NORMAL_ITEM,
      );
        $items['travel_results'] = array(
      'title' => 'Results',
      'page callback' => 'travel_search',
      'access callback' => true,
      'type' => MENU_CALLBACK,
      );
        $items['save_results'] = array(
      'title' => 'My Results',
      'page callback' => 'save_view',
      'access callback' => true,
      'type' => MENU_CALLBACK,
      );
        return $items;
    }

    function travel_form()
    {
        $form['attraction1'] = array(
        '#title' => 'What do you like to do for fun?',
        '#type' => 'textfield',
        '#description' => t('What do you like to do for fun?'),
        '#required' => true,
      );
        $form['attraction2'] = array(
        '#title' => 'What do you like to do for fun?',
        '#type' => 'textfield',
        '#description' => t('List another activity you enjoy'),
        '#required' => true,
      );
        $form['attraction3'] = array(
        '#title' => 'What do you like to do for fun?',
        '#type' => 'textfield',
        '#description' => t('List another activity you enjoy'),
        '#required' => true,
        );
        $form['city'] = array(
        '#title' => 'What city are you visting?',
        '#type' => 'textfield',
        '#description' => t('Please enter a city'),
      );
        $form['active'] = array(
        '#title' => 'How active do you like to be on vacation?',
        '#type' => 'select',
        '#options' => array(
            'relaxed' => 'I like a leisurely trip',
            'active' => 'I like to see everything I can',
            'middle' => 'I like a mix of realxing and seeing what I can'
        ),
        '#description' => t('How active do you like to be on vacation?'),
      );
        $form['days'] = array(
        '#title' => 'How many days is your trip?',
        '#type' => 'textfield',
        '#description' => t('How many days is your trip?'),
      );
        $form['budget'] = array(
        '#title' => 'What is your budget?',
        '#type' => 'select',
        '#options' => array(
            1 => '$',
            2 => '$$',
            3 => '$$$',
            4 => '$$$$',
        ),
        '#description' => t('What is your budget?'),
      );
        $form['mode'] = array(
        '#title' => 'How do you like to get around town?',
        '#type' => 'select',
        '#options' => array(
            'walking' => 'On foot',
            'driving' => 'By car',
            'transit' => 'Using public transport',
            'all' => 'Any of these options',
        ),
        '#description' => t('How do you like to get around town?'),
      );
        $form['submit'] = array(
        '#type' => 'submit',
        '#value' => 'Search',
      );

        return $form;
    }

    function checkbox_form()
    {
        $form['save'] = array(
        '#title' => '',
        '#type' => 'checkboxes',
        '#options' => array(
          1=>'save',
        ),
        '#description' => t('Check to save'),
      );
        $form['submit'] = array(
        '#type' => 'submit',
        '#value' => 'Save',
      );
        return $form;
    }

    function checkbox_form_submit($form, &$form_state)
    {
        $id = $form_state['values']['save'];
        $_SESSION['id'] = $id;
        $form_state['redirect'] = 'save_results';
    }

    function travel_form_submit($form, &$form_state)
    {
        $active = $form_state['values']['active'];
        $attraction1 = $form_state['values']['attraction1'];
        $attraction2 = $form_state['values']['attraction2'];
        $attraction3 = $form_state['values']['attraction3'];
        $budget = $form_state['values']['budget'];
        $city = $form_state['values']['city'];
        $days = $form_state['values']['days'];
        $mode = $form_state['values']['mode'];
        $_SESSION['active'] = $active;
        $_SESSION['attraction1'] = $attraction1;
        $_SESSION['attraction2'] = $attraction2;
        $_SESSION['attraction3'] = $attraction3;
        $_SESSION['budget'] = $budget;
        $_SESSION['city'] = $city;
        $_SESSION['days'] = $days;
        $_SESSION['mode'] = $mode;

        $form_state['redirect'] = 'travel_results';
    }


    function travel_search()
    {
        $active = $_SESSION['active'];
        $activities = array();
        $array_offset = 0;
        $attractions = array();
        //places key
        $api_key = 'AIzaSyAOy8TYrUjMoRdW9-PIVi-50GnmGe_CDi8';
        //   $days = $_SESSION['days'];
        $days = $_SESSION['days'];
        $destintation = '';
        $distance_array = array();
        //maps key
        $maps_key = 'AIzaSyBU9Qh-CcMbmwS_OLHtjyLPXb4Da_xitMk';
        $mode = $_SESSION['mode'];
        $number_of_activities = 0;
        $origin = '';
        $output = '';
        $rating = '';
        $result_array = array();
        $result_string = '';

        //push attractions to array
        array_push($attractions, $attraction1 = $_SESSION['attraction1']);
        array_push($attractions, $attraction2 = $_SESSION['attraction2']);
        array_push($attractions, $attraction3 = $_SESSION['attraction3']);

        //convert days to array
        $days_array = array();
        for ($i=1; $i <= $days ; $i++) {
            array_push($days_array, $i);
        }
        $days = $days_array;

        // form validation
        foreach ($attractions as $attraction) {
            if (str_word_count($attraction) > 1) {
                $attraction = preg_replace('/\s+/', '', $attraction);
                array_push($attractions, $attraction);
            } else {
                array_push($attractions, $attraction);
            }
        }

        $city = $_SESSION['city'];
        if (str_word_count($city) > 1) {
            $city = preg_replace('/\s+/', '', $city);
        } else {
            $city = $city;
        }
        //google places api call
        foreach ($attractions as $attraction) {
            $api_call
             ='https://maps.googleapis.com/maps/api/place/textsearch/json?query='.$attraction.'+in+'.$city.'&key='.$api_key;
            $result_strings = file_get_contents($api_call);
            $result_string .= $result_strings;
        }
        $result_array = json_decode($result_string, true);
        var_dump(json_last_error());
        //determine number of daily activities
        if ($active === "active") {
            $number_of_activities = 3;
        } elseif ($active === "middle") {
            $number_of_activities = 2;
        } else {
            $number_of_activities = 1;
        }
        //check distance between attractions
        for ($i=0; $i < count($result_array['results'])-1; $i++) {
            $origin = $result_array['results'][$i]['formatted_address'];
            if (str_word_count($origin) > 1) {
                $origin = preg_replace('/\s+/', '+', $origin);
            } else {
                $origin = $origin;
            }
            $destination = $result_array['results'][$i +1]['formatted_address'];
            if (str_word_count($destination) > 1) {
                $destination = preg_replace('/\s+/', '+', $destination);
            } else {
                $destination = $destination;
            }
            //maps call
            $maps_call = 'https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&origins='. $origin.'&destinations='.$destination.'&mode='.$mode.'&key='.$maps_key;
            $maps_result_string = file_get_contents($maps_call);
            $maps_result_array = json_decode($maps_result_string, true);
            $distance = $maps_result_array['rows'][0]['elements'][0]['distance']['text'];
            $duration = $maps_result_array['rows'][0]['elements'][0]['duration']['text'];
            if ($mode === "walking" && $distance < "5 mi") {
                array_push($activities, $i);
                array_push($distance_array, $distance);
            } elseif ($mode === "transit" && $distance < "15 mi") {
                array_push($activities, $i);
                array_push($distance_array, $distance);
            } elseif ($distance < "30 mi") {
                array_push($activities, $i);
                array_push($distance_array, $distance);
            }
        }
        foreach ($days as $day) {
            $activity_slice = array_slice($activities, $array_offset, $number_of_activities);
            $array_offset = $array_offset +3;
            $output = $output.<<<EOD
            <div class=well>
            <h1>Itinerary for day $day</h1>
EOD;
            // if ($mode === "transit" || $mode === "all") {
            //     $fare_currency = $maps_result_array['rows'][0]['elements'][0]['fare']['currency'];
            //     $fare_amount = $maps_result_array['rows'][0]['elements'][0]['fare']['text'];
            // }
            foreach ($activity_slice as $activity) {
                $address = $result_array['results'][$activity]['formatted_address'];
                $name = $result_array['results'][$activity]['name'];
                // $value = $i;
                $_SESSION['output'.$i] = $name . $address . $rating;
                $place_id = $result_array['results'][$activity]['place_id'];
                if (empty($result_array['results'][$activity]['rating'])) {
                    $rating = "Sorry no rating";
                } else {
                    $rating = (string)$result_array['results'][$activity]['rating'];
                }
                // $_SESSION['value'] = $value;
                $output = $output.<<<EOD
            <h2>$name</h2>
            <h4>Address: $address </h4>
            <h4>Rating: $rating </h4>
            <h4>$mode distance to next stop : $distance_array[$activity]</h4>
EOD;
            }
            $output.= '</div>';
            $checkbox_output = drupal_get_form('checkbox_form');
            $output .= drupal_render($checkbox_output);
        }
        return $output;
    }

    function save_view()
    {
        $id = $_SESSION['id'];
        $value = $_SESSION['value'];
        if ($id[1] === "1") {
            $output = $_SESSION['output'.$value];
        }
        return $output;
    }
